<!DOCTYPE html>
<html lang="en" style="color-scheme: dark; scroll-behavior: smooth;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Generator Studio Pro</title>
    <style>
        /* --- Pro Dark Theme Palette & Base --- */
        :root { /* ... (Same color vars) ... */
             --bg-base: #202124; --bg-panel: #2d2e30; --bg-input: #35363a; --bg-input-hover: #3c3d41; --border-color: #444548; --border-focus: #4a90e2; --text-primary: #dadce0; --text-secondary: #9aa0a6; --text-placeholder: #70757a; --text-on-accent: #ffffff; --text-on-dark-accent: #000000; --accent-blue: #4a90e2; --accent-blue-hover: #5e9cec; --accent-green: #34a853; --accent-green-hover: #4bc16a; --accent-yellow: #fbbc05; --accent-yellow-hover: #fcd33a; --accent-red: #ea4335; --accent-red-hover: #f16a5e; --accent-purple: #a042f2; --accent-purple-hover: #b062f2; --accent-gray: #5f6368; --accent-gray-hover: #70757a; --border-radius: 4px; --box-shadow-panel: 0 2px 8px rgba(0, 0, 0, 0.4); --box-shadow-focus: 0 0 0 2px rgba(74, 144, 226, 0.3); --accent-blue-rgb: 74, 144, 226; --accent-green-rgb: 52, 168, 83; --accent-yellow-rgb: 251, 188, 5; --accent-red-rgb: 234, 67, 53; --accent-purple-rgb: 160, 66, 242; --accent-gray-rgb: 95, 99, 104;
        }
        body { /* ... body styles ... */ font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji"; line-height: 1.5; padding: 15px; background-color: var(--bg-base); color: var(--text-primary); font-size: 14px; }
        .container { /* ... container styles ... */ max-width: 1350px; margin: 15px auto; background: var(--bg-panel); padding: 20px 25px; border-radius: 8px; box-shadow: var(--box-shadow-panel); border: 1px solid var(--border-color); }
        h1 { /* ... h1 styles ... */ text-align: center; color: var(--text-primary); margin-bottom: 25px; font-weight: 500; font-size: 1.4em; letter-spacing: 0.5px; }
        fieldset { /* ... fieldset styles ... */ border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 12px 15px 15px; margin-bottom: 20px; background: none; }
        legend { /* ... legend styles ... */ font-weight: 500; color: var(--text-secondary); padding: 0 6px; font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px; }

        /* --- Layout Grid --- */
        .layout-grid { display: grid; grid-template-columns: 1fr; gap: 25px; }
        @media (min-width: 992px) { .layout-grid { grid-template-columns: 1fr 340px; gap: 30px; } }

        /* --- Form Elements --- */
        label { /* ... label styles ... */ display: block; margin-bottom: 5px; font-weight: 400; font-size: 0.85em; color: var(--text-secondary); }
        textarea, input[type="text"], select { /* ... input base styles ... */ width: 100%; padding: 8px 10px; margin-bottom: 10px; border: 1px solid var(--border-color); border-radius: var(--border-radius); font-size: 0.9em; box-sizing: border-box; background-color: var(--bg-input); color: var(--text-primary); transition: border-color 0.2s ease, background-color 0.2s ease, box-shadow 0.2s ease; }
        textarea::placeholder, input[type="text"]::placeholder { /* ... placeholder styles ... */ color: var(--text-placeholder); }
        textarea:hover, input[type="text"]:hover, select:hover { /* ... hover styles ... */ background-color: var(--bg-input-hover); border-color: var(--accent-gray); }
        textarea:focus, input[type="text"]:focus, select:focus { /* ... focus styles ... */ border-color: var(--accent-blue); background-color: var(--bg-input); outline: none; box-shadow: var(--box-shadow-focus); }
        textarea { /* ... textarea styles ... */ min-height: 85px; resize: vertical; }
        #negativePromptInput { /* ... negative prompt styles ... */ font-size: 0.85em; color: var(--text-secondary); }
        select { /* ... select styles (with arrow) ... */ cursor: pointer; appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%239aa0a6%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: right 10px center; background-size: 9px auto; padding-right: 28px; }
        select option { /* ... option styles ... */ background-color: var(--bg-input); color: var(--text-primary); }

        /* --- Buttons --- */
        .button-group, .control-group, .keyword-buttons { /* ... group styles ... */ display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; align-items: center; }
        .main-actions { /* ... main actions styles ... */ margin-top: 20px; justify-content: center; gap: 12px; }
        .prompt-controls { /* ... prompt controls styles ... */ display: flex; justify-content: flex-end; gap: 6px; margin-top: -8px; margin-bottom: 8px; align-items: center; }
        .control-group label { /* ... control group label styles ... */ margin-bottom: 0; margin-right: 8px; flex-shrink: 0; white-space: nowrap; }
        .control-group select, .control-group input { /* ... control group input styles ... */ flex-grow: 1; margin-bottom: 0; min-width: 140px; }
        .control-group button:not(.apply-btn) { /* ... control group button styles ... */ flex-shrink: 0; }
        .keyword-buttons button { /* ... keyword button styles ... */ background-color: var(--accent-gray); font-size: 0.75em; padding: 3px 6px; color: var(--text-primary); border: none; }
        .keyword-buttons button:hover:not(:disabled) { /* ... keyword button hover styles ... */ background-color: var(--accent-gray-hover); filter: none; }
        button { /* ... base button styles ... */ padding: 7px 14px; background-color: var(--accent-gray); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: var(--border-radius); cursor: pointer; font-size: 0.85em; font-weight: 500; transition: background-color 0.2s ease, border-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease; }
        button:hover:not(:disabled) { /* ... button hover styles ... */ background-color: var(--accent-gray-hover); border-color: #555; }
        button:active:not(:disabled) { /* ... button active styles ... */ transform: translateY(1px); background-color: #4a4a4e; }
        button:focus-visible { /* ... button focus styles ... */ outline: none; border-color: var(--accent-blue); box-shadow: var(--box-shadow-focus); }
        button:disabled { /* ... button disabled styles ... */ background-color: var(--bg-input); border-color: var(--border-color); color: var(--text-placeholder); cursor: not-allowed; opacity: 0.6; }
        #generateBtn { /* ... generate button styles ... */ background-color: var(--accent-green); border-color: var(--accent-green); color: var(--text-on-accent); font-weight: 500; }
        #generateBtn:hover:not(:disabled) { /* ... generate button hover styles ... */ background-color: var(--accent-green-hover); border-color: var(--accent-green-hover); }
        #cancelBtn { /* ... cancel button styles ... */ background-color: var(--accent-red); border-color: var(--accent-red); display: none; color: var(--text-on-accent); }
        #cancelBtn:hover:not(:disabled) { /* ... cancel button hover styles ... */ background-color: var(--accent-red-hover); border-color: var(--accent-red-hover); }
        #enhanceAIBtn, #modifyBtn { /* ... enhance/modify styles ... */ background-color: var(--accent-blue); border-color: var(--accent-blue); color: var(--text-on-accent); }
        #enhanceAIBtn:hover:not(:disabled), #modifyBtn:hover:not(:disabled) { /* ... enhance/modify hover styles ... */ background-color: var(--accent-blue-hover); border-color: var(--accent-blue-hover); }
        .apply-btn { /* ... apply button styles ... */ background-color: var(--accent-purple); border-color: var(--accent-purple); color: var(--text-on-accent); font-size: 0.8em; padding: 6px 12px; }
        .apply-btn:hover:not(:disabled) { /* ... apply button hover styles ... */ background-color: var(--accent-purple-hover); border-color: var(--accent-purple-hover); }
        .clear-btn, .history-btn, #resetNegativeBtn { /* ... small button styles ... */ font-size: 0.75em; padding: 4px 8px; background-color: var(--bg-input); border-color: var(--border-color); color: var(--text-secondary); }
        .clear-btn:hover:not(:disabled), .history-btn:hover:not(:disabled), #resetNegativeBtn:hover:not(:disabled) { /* ... small button hover styles ... */ background-color: var(--bg-input-hover); border-color: var(--accent-gray); color: var(--text-primary); }
        .clear-btn.danger { /* ... clear history styles ... */ background-color: rgba(var(--accent-red-rgb), 0.2); border-color: rgba(var(--accent-red-rgb), 0.4); color: var(--accent-red); }
        .clear-btn.danger:hover:not(:disabled) { /* ... clear history hover styles ... */ background-color: rgba(var(--accent-red-rgb), 0.3); border-color: var(--accent-red); color: #ffcccb; }
        .ollama-actions { /* ... ollama actions group ... */ display: flex; gap: 8px; }
        .ollama-actions button { /* ... ollama action button sizing ... */ flex-grow: 1; }

        /* --- Image & Status Area --- */
        #image-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); /* Grid layout */
            gap: 12px; margin-top: 20px; min-height: 160px;
            border: 1px solid var(--border-color); padding: 12px;
            background-color: var(--bg-base); border-radius: var(--border-radius);
        }
        .image-placeholder, #image-container img { /* ... placeholder/img base styles ... */ width: 100%; height: auto; aspect-ratio: 1 / 1; display: flex; justify-content: center; align-items: center; border-radius: var(--border-radius); background-color: var(--bg-input); border: 1px solid var(--border-color); box-sizing: border-box; font-size: 0.85em; color: var(--text-secondary); overflow: hidden; text-align: center; flex-direction: column; padding: 8px; }
        #image-container img { /* ... img specific styles ... */ object-fit: contain; background-color: var(--bg-base); border-color: transparent; cursor: zoom-in; /* MAKE CLICKABLE */ transition: transform 0.2s ease-out, box-shadow 0.2s ease-out; }
        #image-container img:hover { /* ... img hover styles ... */ transform: scale(1.02); box-shadow: 0 3px 10px rgba(0,0,0,0.5); z-index: 10; position: relative; }
        .image-placeholder.loading::after { /* ... spinner styles ... */ content: ''; display: block; width: 24px; height: 24px; border: 3px solid var(--accent-gray); border-left-color: var(--accent-blue); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 6px; }
        .image-placeholder .placeholder-status { /* ... placeholder status text styles ... */ margin-bottom: auto; font-size: 0.9em; }
        .image-placeholder.error { /* ... error placeholder styles ... */ background-color: rgba(var(--accent-red-rgb), 0.1); color: var(--accent-red); border-color: rgba(var(--accent-red-rgb), 0.3); }
        .image-placeholder.cancelled { /* ... cancelled placeholder styles ... */ background-color: rgba(var(--accent-gray-rgb), 0.1); color: var(--accent-gray); border-color: rgba(var(--accent-gray-rgb), 0.3); }
        .image-placeholder small { /* ... placeholder small text styles ... */ font-size: 0.8em; margin-top: 4px; color: inherit; }
        .debug-url { /* ... debug url styles ... */ font-family: "Menlo", "Consolas", monospace; font-size: 0.7em; word-break: break-all; color: var(--text-placeholder); background-color: rgba(0,0,0,0.15); padding: 2px 4px; border-radius: 3px; margin-top: 6px; max-height: 30%; overflow-y: auto; display: block; text-align: left; width: 100%; border: 1px solid var(--border-color); }
        .image-placeholder.error .debug-url, .image-placeholder.cancelled .debug-url { /* ... error/cancelled debug url styles ... */ color: inherit; background-color: rgba(255,255,255,0.03); }
        @keyframes spin { /* ... spin animation ... */ 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- Status & Info --- */
        .status-message { /* ... status message styles ... */ display: block; text-align: center; font-style: normal; font-size: 0.85em; color: var(--text-secondary); padding: 8px 12px; min-height: 1.2em; margin: 15px 0; border-radius: var(--border-radius); border: 1px solid var(--border-color); background-color: var(--bg-input); }
        .status-message:empty { /* ... hide empty status ... */ display: none; }
        .status-message.loading { /* ... loading status styles ... */ color: var(--accent-blue); border-color: var(--accent-blue); background-color: rgba(var(--accent-blue-rgb), 0.1); }
        .status-message.success { /* ... success status styles ... */ color: var(--accent-green); border-color: var(--accent-green); background-color: rgba(var(--accent-green-rgb), 0.1); }
        .status-message.warning { /* ... warning status styles ... */ color: var(--accent-yellow); border-color: var(--accent-yellow); background-color: rgba(var(--accent-yellow-rgb), 0.1); }
        .status-message.error { /* ... error status styles ... */ color: var(--accent-red); border-color: var(--accent-red); background-color: rgba(var(--accent-red-rgb), 0.1); font-weight: 500; }
        .info-box { /* ... info box styles ... */ font-size: 0.85em; color: var(--accent-blue); background-color: rgba(var(--accent-blue-rgb), 0.1); border: 1px solid rgba(var(--accent-blue-rgb), 0.3); border-radius: var(--border-radius); margin-bottom: 20px; padding: 10px 15px; }
        .info-box strong { /* ... info box strong styles ... */ font-weight: 500; color: inherit; }

        /* --- Lightbox Styles (Should be correct) --- */
        .lightbox { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9); overflow: hidden; backdrop-filter: blur(4px); }
        .lightbox-content { position: relative; margin: auto; padding: 0; width: 90%; height: 90%; max-width: 1100px; top: 50%; transform: translateY(-50%); display: flex; justify-content: center; align-items: center; }
        .lightbox-image { display: block; max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 3px; box-shadow: 0 8px 30px rgba(0,0,0,0.6); }
        .lightbox-close, .lightbox-prev, .lightbox-next { cursor: pointer; position: absolute; color: var(--text-secondary); background-color: rgba(40, 40, 40, 0.8); border: 1px solid var(--border-color); padding: 8px 12px; font-size: 22px; font-weight: bold; transition: background-color 0.2s ease, color 0.2s ease; border-radius: 50%; line-height: 1; width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; }
        .lightbox-close:hover, .lightbox-prev:hover, .lightbox-next:hover { background-color: rgba(60, 60, 60, 0.9); color: var(--text-primary); }
        .lightbox-close { top: 20px; right: 30px; font-size: 28px; padding: 5px 10px; width: 40px; height: 40px; }
        .lightbox-prev, .lightbox-next { top: 50%; transform: translateY(-50%); }
        .lightbox-prev { left: 20px; }
        .lightbox-next { right: 20px; }
        .lightbox-prev.disabled, .lightbox-next.disabled { opacity: 0.3; cursor: default; pointer-events: none; }

        /* --- Sidebar Tabs --- */
        .tab-container { margin-bottom: 20px; border: 1px solid var(--border-color); border-radius: var(--border-radius); background: var(--bg-base); }
        .tab-nav { display: flex; border-bottom: 1px solid var(--border-color); background: var(--bg-input); padding: 5px 5px 0 5px; border-radius: var(--border-radius) var(--border-radius) 0 0; }
        .tab-button { background-color: transparent; border: 1px solid transparent; border-bottom: none; color: var(--text-secondary); padding: 6px 12px; font-size: 0.8em; border-radius: var(--border-radius) var(--border-radius) 0 0; margin-bottom: -1px; /* Overlap border */ position: relative; top: 1px; flex-grow: 1; text-align: center; }
        .tab-button:hover { background-color: var(--bg-input-hover); color: var(--text-primary); }
        .tab-button.active { background-color: var(--bg-base); border-color: var(--border-color); color: var(--text-primary); font-weight: 500; border-bottom-color: var(--bg-base); /* Hide bottom border */ }
        .tab-button:focus-visible { outline: none; box-shadow: inset 0 0 0 2px var(--accent-blue); z-index: 1; }
        .tab-content { padding: 15px 15px 5px 15px; display: none; /* Hide inactive tabs */ }
        .tab-content.active { display: block; /* Show active tab */ }
        .tab-content fieldset { border: none; padding: 0; margin: 0 0 10px 0; } /* Remove fieldset border inside tabs */
        .tab-content legend { /* Style legend inside tabs if needed, e.g., smaller */ font-size: 0.85em; margin-bottom: 8px; }
        .tab-content .control-group { margin-bottom: 12px; /* Adjust spacing inside tabs */ }

        /* --- Responsive Overrides --- */
        @media (max-width: 991px) { .layout-grid { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { /* ... responsive styles ... */ body { font-size: 13px; padding: 10px; } .container { padding: 15px; margin: 10px auto; } h1 { font-size: 1.4em; margin-bottom: 20px; } fieldset:not(.tab-content fieldset) { padding: 10px 12px 12px; margin-bottom: 15px; } .control-group { flex-direction: column; align-items: stretch; } .control-group label { margin-bottom: 4px; } .main-actions button { width: 100%; margin-bottom: 8px; padding: 10px; } #image-container { grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 8px; padding: 10px; } .lightbox-prev, .lightbox-next { font-size: 18px; width: 36px; height: 36px; padding: 8px 10px; } .lightbox-close { font-size: 22px; top: 10px; right: 15px; width: 34px; height: 34px; } .lightbox-content { width: 96%; height: 90%; } .tab-button { font-size: 0.75em; padding: 5px 8px; } }
    </style>
</head>
<body>
    <div class="container">
        <h1>AI Image Generator Studio</h1>
         <div class="info-box">
             Using <strong>Pollinations.ai</strong> & local <strong>Ollama</strong> (<code id="ollamaModelDisplay">llama3.2</code>). Negatives are defaults (editable) but <strong>not</strong> sent to Pollinations. Click images to zoom.
        </div>

        <!-- Layout Grid -->
        <div class="layout-grid">
            <!-- Main Column -->
            <div class="main-column">
                <fieldset> <legend>Prompting Area</legend>
                    <label for="promptInput">Prompt:</label><div class="prompt-controls"><button id="clearPromptBtn" class="clear-btn" title="Clear Prompt">Clear</button></div><textarea id="promptInput" rows="5" placeholder="Describe the main subject and scene..."></textarea>
                    <label for="negativePromptInput">Negative Keywords (Defaults Provided - Edit as Needed):</label><div class="prompt-controls"><button id="resetNegativeBtn" class="clear-btn" title="Reset to Defaults">Reset</button><button id="clearNegativeBtn" class="clear-btn" title="Clear Negatives">Clear</button></div><textarea id="negativePromptInput" rows="3" title="These keywords are NOT sent to Pollinations via this tool, but are provided as common defaults. Edit freely."></textarea>
                    <label>Quick Add Keywords (to Main Prompt):</label><div class="keyword-buttons"><button data-keyword="photorealistic">Photorealistic</button><button data-keyword="cinematic lighting">Cinematic</button><button data-keyword="highly detailed">Detailed</button><button data-keyword="intricate details">Intricate</button><button data-keyword="sharp focus">Sharp Focus</button><button data-keyword="4k">4K</button><button data-keyword="8k">8K</button><button data-keyword="masterpiece">Masterpiece</button><button data-keyword="trending on artstation">Artstation</button><button data-keyword="wide angle shot">Wide Angle</button><button data-keyword="close up portrait">Close Up</button><button data-keyword="minimalist">Minimalist</button></div>
                </fieldset>
                <div id="status" class="status-message"></div>
                <div class="button-group main-actions"><button id="generateBtn">Generate Images</button><button id="cancelBtn">Cancel Generation</button></div>
                <div id="image-container"><p style="color: var(--text-secondary); text-align: center; grid-column: 1 / -1; font-style: italic; font-size: 0.9em;">Image results appear here.</p></div>
            </div> <!-- End Main Column -->

            <!-- Sidebar Column -->
            <div class="sidebar-column">
                <!-- START: Tabbed Interface for Refinements -->
                <div class="tab-container">
                    <div class="tab-nav">
                        <button class="tab-button active" data-tab="tab-visuals">Visuals</button>
                        <button class="tab-button" data-tab="tab-scene">Scene</button>
                        <button class="tab-button" data-tab="tab-camera">Camera</button>
                    </div>

                    <!-- Tab 1: Visuals Content -->
                    <div class="tab-content active" id="tab-visuals">
                        <fieldset><legend>Style & Feel</legend>
                            <div class="control-group">
                                <label for="styleSelector">Style:</label>
                                <select id="styleSelector"><option value="">-- Select --</option><option value="Photorealistic">Photorealistic</option><option value="Cinematic">Cinematic</option><option value="Anamorphic lens flare">Anamorphic Flare</option><option value="Shallow depth of field">Shallow DOF</option><option value="Film Noir">Film Noir</option><option value="Anime">Anime</option><option value="Manga">Manga</option><option value="Studio Ghibli style">Studio Ghibli</option><option value="Illustration">Illustration</option><option value="Children's book illustration">Children's Book</option><option value="Concept Art">Concept Art</option><option value="Digital Painting">Digital Painting</option><option value="Oil Painting">Oil Painting</option><option value="Watercolor">Watercolor</option><option value="Impressionism">Impressionism</option><option value="Surrealism">Surrealism</option><option value="Cubism">Cubism</option><option value="Abstract">Abstract</option><option value="Minimalist Style">Minimalist Style</option><option value="Steampunk">Steampunk</option><option value="Cyberpunk">Cyberpunk</option><option value="Synthwave">Synthwave</option><option value="Fantasy Art">Fantasy Art</option><option value="Sci-Fi Art">Sci-Fi Art</option><option value="Pixel Art">Pixel Art</option><option value="Low Poly">Low Poly</option><option value="Isometric">Isometric</option><option value="Claymation">Claymation</option><option value="Line Art">Line Art</option><option value="Sketch">Sketch</option><option value="Sticker illustration">Sticker</option><option value="Vintage photography">Vintage Photo</option></select>
                                <button id="applyStyleBtn" class="apply-btn">Apply</button>
                            </div>
                            <div class="control-group">
                                <label for="moodSelector">Mood:</label>
                                <select id="moodSelector"><option value="">-- Select --</option><option value="Happy">Happy</option><option value="Serene">Serene</option><option value="Mysterious">Mysterious</option><option value="Dramatic">Dramatic</option><option value="Epic">Epic</option><option value="Whimsical">Whimsical</option><option value="Dark">Dark</option><option value="Gloomy">Gloomy</option><option value="Romantic">Romantic</option><option value="Nostalgic">Nostalgic</option><option value="Energetic">Energetic</option><option value="Peaceful">Peaceful</option></select>
                                <button id="applyMoodBtn" class="apply-btn">Apply</button>
                            </div>
                            <div class="control-group">
                                <label for="colorPaletteSelector">Color Palette:</label>
                                <select id="colorPaletteSelector"><option value="">-- Select --</option><option value="Warm Tones">Warm Tones</option><option value="Cool Tones">Cool Tones</option><option value="Monochromatic color scheme">Monochromatic</option><option value="Complementary Colors">Complementary</option><option value="Analogous Colors">Analogous</option><option value="Pastel Colors">Pastel Colors</option><option value="Vibrant Saturated Colors">Vibrant / Saturated</option><option value="Muted Desaturated Colors">Muted / Desaturated</option><option value="Earthy Tones">Earthy Tones</option><option value="Neon Electric Colors">Neon / Electric</option><option value="Black and White">Black and White</option></select>
                                <button id="applyColorPaletteBtn" class="apply-btn">Apply</button>
                            </div>
                        </fieldset>
                    </div>

                    <!-- Tab 2: Scene Content -->
                    <div class="tab-content" id="tab-scene">
                         <fieldset><legend>Setting & Atmosphere</legend>
                            <div class="control-group">
                                <label for="lightingSelector">Lighting:</label>
                                <select id="lightingSelector"><option value="">-- Select --</option><option value="Natural Daylight">Natural Daylight</option><option value="Golden Hour Light">Golden Hour</option><option value="Blue Hour Light">Blue Hour</option><option value="Overcast Sky">Overcast</option><option value="Dramatic Studio Lighting">Studio Lighting</option><option value="Backlit">Backlit / Rim</option><option value="Volumetric Lighting">Volumetric / God Rays</option><option value="Neon Glow">Neon Glow</option><option value="Candlelight">Candlelight / Firelight</option><option value="Moonlight">Moonlight</option><option value="Cinematic Lighting">Cinematic Lighting</option><option value="Soft Ambient Light">Soft Ambient</option></select>
                                <button id="applyLightingBtn" class="apply-btn">Apply</button>
                            </div>
                            <div class="control-group">
                                <label for="timeOfDaySelector">Time:</label>
                                <select id="timeOfDaySelector"><option value="">-- Select --</option><option value="Sunrise">Sunrise / Dawn</option><option value="Morning">Morning</option><option value="Midday">Midday / Noon</option><option value="Afternoon">Afternoon</option><option value="Golden Hour">Golden Hour</option><option value="Sunset">Sunset / Dusk</option><option value="Twilight">Twilight</option><option value="Night">Night</option><option value="Midnight">Midnight</option></select>
                                <button id="applyTimeOfDayBtn" class="apply-btn">Apply</button>
                            </div>
                            <div class="control-group">
                                <label for="environmentSelector">Environment:</label>
                                <select id="environmentSelector"><option value="">-- Select --</option><option value="Urban Cityscape">Urban / Cityscape</option><option value="Natural Landscape">Nature / Landscape</option><option value="Interior Room">Interior</option><option value="Underwater Scene">Underwater</option><option value="Outer Space Scene">Outer Space / Sci-Fi</option><option value="Surreal Dreamscape">Surreal / Dreamscape</option><option value="Industrial Setting">Industrial / Factory</option><option value="Rural Countryside">Rural / Countryside</option><option value="Abstract Background">Abstract Background</option></select>
                                <button id="applyEnvironmentBtn" class="apply-btn">Apply</button>
                            </div>
                            <div class="control-group">
                                <label for="weatherSelector">Weather:</label>
                                <select id="weatherSelector"><option value="">-- Select --</option><option value="Clear Sunny Day">Clear / Sunny</option><option value="Partly Cloudy">Partly Cloudy</option><option value="Overcast Gloomy">Overcast / Gloomy</option><option value="Foggy Misty">Foggy / Misty</option><option value="Rainy">Rainy</option><option value="Heavy Rain Storm">Heavy Rain / Storm</option><option value="Snowing">Snowing</option><option value="Windy">Windy</option><option value="Hazy Polluted">Hazy / Polluted</option><option value="Magical Ethereal Atmosphere">Magical / Ethereal</option></select>
                                <button id="applyWeatherBtn" class="apply-btn">Apply</button>
                            </div>
                        </fieldset>
                    </div>

                    <!-- Tab 3: Camera Content -->
                    <div class="tab-content" id="tab-camera">
                         <fieldset><legend>Framing</legend>
                            <div class="control-group">
                                <label for="angleSelector">Angle:</label>
                                <select id="angleSelector"><option value="">-- Select --</option><option value="Eye Level Shot">Eye Level</option><option value="Low Angle Shot">Low Angle</option><option value="High Angle Shot">High Angle</option><option value="Birds Eye View">Bird's Eye View</option><option value="Worms Eye View">Worm's Eye View</option><option value="Dutch Angle">Dutch Angle</option><option value="Over the Shoulder Shot">Over the Shoulder</option><option value="Close Up Shot">Close Up</option><option value="Medium Shot">Medium Shot</option><option value="Full Shot">Full Shot</option><option value="Wide Shot">Wide Shot</option><option value="Extreme Wide Shot">Extreme Wide</option></select>
                                <button id="applyAngleBtn" class="apply-btn">Apply</button>
                            </div>
                            <div class="control-group">
                                <label for="compositionSelector">Composition:</label>
                                <select id="compositionSelector"><option value="">-- Select --</option><option value="Rule of Thirds">Rule of Thirds</option><option value="Centered Composition">Centered</option><option value="Symmetrical Composition">Symmetrical</option><option value="Asymmetrical Balance">Asymmetrical</option><option value="Leading Lines">Leading Lines</option><option value="Frame within a Frame">Framed</option><option value="Golden Ratio">Golden Ratio</option><option value="Diagonal Composition">Diagonal</option><option value="Dynamic Composition">Dynamic</option></select>
                                <button id="applyCompositionBtn" class="apply-btn">Apply</button>
                            </div>
                        </fieldset>
                    </div>
                </div>
                 <!-- END: Tabbed Interface for Refinements -->

                 <fieldset><legend>Ollama Controls</legend>
                    <div class="control-group"><label for="modificationInstructionInput">Modify Instr.:</label><input type="text" id="modificationInstructionInput" placeholder="Instruct Ollama..."></div>
                    <div class="control-group"><label for="ollamaModelInput">Model:</label><input type="text" id="ollamaModelInput" value="llama3.2"></div>
                    <div class="ollama-actions"><button id="enhanceAIBtn">Enhance</button><button id="modifyBtn">Modify</button></div>
                 </fieldset>
                 <fieldset><legend>Output Settings</legend><div class="control-group"><label for="imageCountSelector">Image Count:</label><select id="imageCountSelector"><option value="1">1</option><option value="2">2</option><option value="3" selected>3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option></select></div></fieldset>
                 <fieldset><legend>Prompt History</legend><div class="control-group"><label for="promptHistorySelector">Load:</label><select id="promptHistorySelector"><option value="">-- History --</option></select></div><div class="button-group"><button id="loadHistoryBtn" class="history-btn">Load Selected</button><button id="clearHistoryBtn" class="clear-btn danger history-btn">Clear All History</button></div></fieldset>
            </div> <!-- End Sidebar -->
        </div> <!-- End Layout Grid -->
    </div> <!-- End Container -->

    <!-- Lightbox Structure -->
    <div id="lightbox" class="lightbox">
        <button class="lightbox-close" id="lightboxCloseBtn" title="Close">&times;</button>
        <button class="lightbox-prev" id="lightboxPrevBtn" title="Previous">&#10094;</button>
        <button class="lightbox-next" id="lightboxNextBtn" title="Next">&#10095;</button>
        <div class="lightbox-content">
            <img src="" alt="Zoomed Image" id="lightboxImage" class="lightbox-image">
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        // (Keep all existing const declarations - they are still valid)
        const promptInput = document.getElementById('promptInput');
        const negativePromptInput = document.getElementById('negativePromptInput');
        const modificationInstructionInput = document.getElementById('modificationInstructionInput');
        const styleSelector = document.getElementById('styleSelector');
        const moodSelector = document.getElementById('moodSelector');
        const angleSelector = document.getElementById('angleSelector');
        const compositionSelector = document.getElementById('compositionSelector');
        const lightingSelector = document.getElementById('lightingSelector');
        const colorPaletteSelector = document.getElementById('colorPaletteSelector');
        const timeOfDaySelector = document.getElementById('timeOfDaySelector');
        const environmentSelector = document.getElementById('environmentSelector');
        const weatherSelector = document.getElementById('weatherSelector');
        const ollamaModelInput = document.getElementById('ollamaModelInput');
        const imageCountSelector = document.getElementById('imageCountSelector');
        const promptHistorySelector = document.getElementById('promptHistorySelector');
        const ollamaModelDisplay = document.getElementById('ollamaModelDisplay');
        const generateBtn = document.getElementById('generateBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const enhanceAIBtn = document.getElementById('enhanceAIBtn');
        const modifyBtn = document.getElementById('modifyBtn');
        const applyStyleBtn = document.getElementById('applyStyleBtn');
        const applyMoodBtn = document.getElementById('applyMoodBtn');
        const applyAngleBtn = document.getElementById('applyAngleBtn');
        const applyCompositionBtn = document.getElementById('applyCompositionBtn');
        const applyLightingBtn = document.getElementById('applyLightingBtn');
        const applyColorPaletteBtn = document.getElementById('applyColorPaletteBtn');
        const applyTimeOfDayBtn = document.getElementById('applyTimeOfDayBtn');
        const applyEnvironmentBtn = document.getElementById('applyEnvironmentBtn');
        const applyWeatherBtn = document.getElementById('applyWeatherBtn');
        const loadHistoryBtn = document.getElementById('loadHistoryBtn');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        const clearPromptBtn = document.getElementById('clearPromptBtn');
        const clearNegativeBtn = document.getElementById('clearNegativeBtn');
        const resetNegativeBtn = document.getElementById('resetNegativeBtn');
        const keywordButtonsContainer = document.querySelector('.keyword-buttons');
        const imageContainer = document.getElementById('image-container');
        const statusDiv = document.getElementById('status');
        const lightbox = document.getElementById('lightbox');
        const lightboxImage = document.getElementById('lightboxImage');
        const lightboxCloseBtn = document.getElementById('lightboxCloseBtn');
        const lightboxPrevBtn = document.getElementById('lightboxPrevBtn');
        const lightboxNextBtn = document.getElementById('lightboxNextBtn');
        // Tab Elements
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');


        // --- State Variables ---
        let currentImageLoadPromise = null; let generationCancelled = false; let currentBatchImageSources = []; let currentLightboxIndex = 0;

        // --- Config ---
        const OLLAMA_ENDPOINT = 'http://localhost:11434'; const POLLINATIONS_BASE_URL = 'https://image.pollinations.ai/prompt/'; const PROMPT_HISTORY_KEY = 'promptHistory_v2'; const MAX_HISTORY_SIZE = 30; const INTER_REQUEST_DELAY_MS = 400; const STANDARD_NEGATIVE_KEYWORDS = [ "ugly", "tiling", "poorly drawn hands", "poorly drawn feet", "poorly drawn face", "out of frame", "extra limbs", "disfigured", "deformed", "body out of frame", "bad anatomy", "watermark", "signature", "cut off", "low contrast", "underexposed", "overexposed", "bad art", "beginner", "amateur", "weird colors", "blurry", "text", "words", "letters", "too many fingers", "username", "artist name", "error", "duplicate" ];

        // --- Helper Functions ---
        function showStatus(message, type = 'info', duration = 0) { statusDiv.textContent = message; statusDiv.className = `status-message ${type}`; if (duration > 0) { setTimeout(clearStatus, duration); } }
        function clearStatus() { if (!statusDiv.classList.contains('error') && !statusDiv.classList.contains('warning')) { statusDiv.textContent = ''; statusDiv.className = 'status-message'; } }
        // UPDATED: Includes all Apply buttons, even though they are now in tabs
        function setOperationalButtonsDisabled(disabled) {
            [generateBtn, enhanceAIBtn, modifyBtn, applyStyleBtn, applyMoodBtn, applyAngleBtn, applyCompositionBtn, applyLightingBtn, applyColorPaletteBtn, applyTimeOfDayBtn, applyEnvironmentBtn, applyWeatherBtn, loadHistoryBtn].forEach(btn => btn.disabled = disabled);
        }
        function appendToPrompt(textToAdd) { let currentPrompt = promptInput.value.trim(); if (textToAdd && !currentPrompt.toLowerCase().includes(textToAdd.toLowerCase())) { if (currentPrompt && !currentPrompt.endsWith(',')) { promptInput.value = currentPrompt + ", " + textToAdd; } else if (currentPrompt) { promptInput.value = currentPrompt + " " + textToAdd; } else { promptInput.value = textToAdd; } } }
        function applySelectorValue(selectorId, statusName) { const selector = document.getElementById(selectorId); const selectedValue = selector.value; if (!selectedValue) { showStatus(`Select ${statusName} first.`, "warning", 3000); return; } appendToPrompt(selectedValue); showStatus(`${statusName} "${selectedValue}" appended.`, 'info', 2000); selector.value = ""; }
        function cleanOllamaResponse(rawResponse) { /* ... same cleaning logic ... */ let cleaned = rawResponse.trim(); console.log("Raw Ollama:", rawResponse); const prefixes = [ "Okay, here's the enhanced prompt:", "Okay, here is the enhanced prompt:", "Sure, here's the enhanced prompt:", "Sure, here is the enhanced prompt:", "Here's the enhanced prompt:", "Here is the enhanced prompt:", "Enhanced prompt:", "Modified prompt:", "Okay, here's the modified prompt:", "Okay, here is the modified prompt:", "Sure, here's the modified prompt:", "Sure, here is the modified prompt:", "Here's the modified prompt:", "Here is the modified prompt:", "Okay, here it is:", "Okay, here's that:", "Okay, here you go:", "Sure thing:", "Certainly:", "Alright:", "Okay:", "Here:", ]; for (const prefix of prefixes) { if (cleaned.toLowerCase().startsWith(prefix.toLowerCase())) { cleaned = cleaned.substring(prefix.length).trim(); break; } } if (cleaned.startsWith('```') && cleaned.endsWith('```')) { cleaned = cleaned.substring(3, cleaned.length - 3).trim(); } if ((cleaned.startsWith('"') && cleaned.endsWith('"')) || (cleaned.startsWith("'") && cleaned.endsWith("'"))) { cleaned = cleaned.substring(1, cleaned.length - 1).trim(); } const lastNewlineIndex = cleaned.lastIndexOf('\n'); if (lastNewlineIndex > cleaned.length / 2) { const potentialExplanation = cleaned.substring(lastNewlineIndex + 1).trim(); if (potentialExplanation.toLowerCase().includes("i hope this") || potentialExplanation.toLowerCase().includes("let me know if")) { cleaned = cleaned.substring(0, lastNewlineIndex).trim(); } } console.log("Cleaned Ollama:", cleaned); return cleaned; }


        // --- LocalStorage History ---
        function loadPromptHistory() { const history = JSON.parse(localStorage.getItem(PROMPT_HISTORY_KEY) || '[]'); promptHistorySelector.innerHTML = '<option value="">-- History --</option>'; history.forEach(promptText => { if (promptText) { const option = document.createElement('option'); option.value = promptText; option.textContent = promptText.length > 80 ? promptText.substring(0, 77) + '...' : promptText; promptHistorySelector.appendChild(option); } }); }
        function saveToPromptHistory(promptText) { if (!promptText || promptText.length < 5) return; let history = JSON.parse(localStorage.getItem(PROMPT_HISTORY_KEY) || '[]'); history = history.filter(item => item !== promptText); history.unshift(promptText); if (history.length > MAX_HISTORY_SIZE) { history = history.slice(0, MAX_HISTORY_SIZE); } localStorage.setItem(PROMPT_HISTORY_KEY, JSON.stringify(history)); loadPromptHistory(); }
        function handleLoadFromHistory() { const selectedPrompt = promptHistorySelector.value; console.log("Load History Clicked. Value:", selectedPrompt); if (selectedPrompt) { promptInput.value = selectedPrompt; console.log("Set prompt to:", promptInput.value); showStatus('Prompt loaded.', 'info', 2000); } else { console.log("No history selected."); showStatus('Select prompt first.', 'warning', 3000); } }
        function handleClearHistory() { if (confirm('Clear entire prompt history?')) { localStorage.removeItem(PROMPT_HISTORY_KEY); loadPromptHistory(); showStatus('History cleared.', 'info', 2500); } }


        // --- Ollama Interaction ---
        async function callOllama(promptForOllama, model) { const response = await fetch(`${OLLAMA_ENDPOINT}/api/generate`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ model: model, prompt: promptForOllama, stream: false }), }); if (!response.ok) { let eMsg=`Ollama(${model}): ${response.status} ${response.statusText}`; try { const d = await response.json(); eMsg+=` - ${d.error||'Unknown.'}`; } catch(e){} if (response.status === 0 || response.type === 'error') { eMsg = 'Net Err: Ollama running? CORS? F12?'; } else if (response.status === 404) { eMsg+= ` '${model}' pulled?`; } throw new Error(eMsg); } const data = await response.json(); if (data?.response) { return data.response.trim(); } else { throw new Error(`Ollama(${model}) empty/invalid response.`); } }
        async function enhancePromptAI() { const originalPrompt = promptInput.value.trim(); if (!originalPrompt) { showStatus('Enter prompt first.', 'warning', 3000); return; } const selectedModel = ollamaModelInput.value.trim(); if (!selectedModel) { showStatus('Enter Ollama model name first.', 'warning', 3000); return; } const metaPrompt = `You are an AI assistant that enhances image generation prompts. User Prompt: "${originalPrompt}" Task: Rewrite the user prompt to be more detailed and evocative for an image generation model. Add relevant keywords (style, lighting, quality, composition, details) while keeping the core subject. Constraint: Output ONLY the final enhanced prompt text. Do not include conversational phrases, explanations, labels, or markdown formatting like quotes or code blocks. Just the prompt string itself.`; showStatus(`Enhancing via ${selectedModel}...`, 'loading'); setOperationalButtonsDisabled(true); try { const rawResponse = await callOllama(metaPrompt, selectedModel); const cleanedPrompt = cleanOllamaResponse(rawResponse); promptInput.value = cleanedPrompt; saveToPromptHistory(cleanedPrompt); showStatus('Prompt enhanced!', 'success', 3000); } catch (error) { console.error('Ollama Enhance:', error); showStatus(error.message, 'error'); } finally { setOperationalButtonsDisabled(false); } }
        async function modifyPromptAI() { const currentPrompt = promptInput.value.trim(); const instruction = modificationInstructionInput.value.trim(); if (!currentPrompt) { showStatus('Prompt empty.', 'warning', 3000); return; } if (!instruction) { showStatus('Enter instruction.', 'warning', 3000); return; } const selectedModel = ollamaModelInput.value.trim(); if (!selectedModel) { showStatus('Enter Ollama model name first.', 'warning', 3000); return; } const metaPrompt = `You are an AI assistant that modifies image generation prompts based on instructions. Original Prompt: "${currentPrompt}" Instruction: "${instruction}" Task: Modify the original prompt according to the instruction, applying the change intelligently and keeping the rest coherent. Constraint: Output ONLY the final modified prompt text. Do not include conversational phrases, explanations, labels, or markdown formatting like quotes or code blocks. Just the prompt string itself.`; showStatus(`Modifying via ${selectedModel}...`, 'loading'); setOperationalButtonsDisabled(true); try { const rawResponse = await callOllama(metaPrompt, selectedModel); const cleanedPrompt = cleanOllamaResponse(rawResponse); promptInput.value = cleanedPrompt; saveToPromptHistory(cleanedPrompt); modificationInstructionInput.value = ''; showStatus('Prompt modified!', 'success', 3000); } catch (error) { console.error('Ollama Modify:', error); showStatus(error.message, 'error'); } finally { setOperationalButtonsDisabled(false); } }

        // --- Style & Keywords ---
        // (Apply button listeners remain the same, just referencing the button IDs)
         keywordButtonsContainer.addEventListener('click', (event) => { if (event.target.tagName === 'BUTTON' && event.target.dataset.keyword) { const k = event.target.dataset.keyword; appendToPrompt(k); showStatus(`"${k}" added.`, 'info', 1500); } });
         applyStyleBtn.addEventListener('click', () => applySelectorValue('styleSelector', 'Style'));
         applyMoodBtn.addEventListener('click', () => applySelectorValue('moodSelector', 'Mood'));
         applyAngleBtn.addEventListener('click', () => applySelectorValue('angleSelector', 'Angle'));
         applyCompositionBtn.addEventListener('click', () => applySelectorValue('compositionSelector', 'Composition'));
         applyLightingBtn.addEventListener('click', () => applySelectorValue('lightingSelector', 'Lighting'));
         applyColorPaletteBtn.addEventListener('click', () => applySelectorValue('colorPaletteSelector', 'Color Palette'));
         applyTimeOfDayBtn.addEventListener('click', () => applySelectorValue('timeOfDaySelector', 'Time of Day'));
         applyEnvironmentBtn.addEventListener('click', () => applySelectorValue('environmentSelector', 'Environment'));
         applyWeatherBtn.addEventListener('click', () => applySelectorValue('weatherSelector', 'Weather'));

        // --- Pollinations Image Generation & Cancellation ---
        // (No changes needed in these functions for the tabs)
        function cancelImageGeneration() { generationCancelled = true; if (currentImageLoadPromise) { const currentImg = document.getElementById('loading-image-element'); if(currentImg) { currentImg.src = ''; } showStatus('Cancellation requested...', 'warning'); } else { showStatus('Generation cancelled.', 'info', 3000); } cancelBtn.style.display = 'none'; setOperationalButtonsDisabled(false); }
        function loadSingleImage(index, total, encodedPrompt, mainPrompt, seed) { return new Promise(async (resolve, reject) => { const placeholder = document.createElement('div'); placeholder.className = 'image-placeholder loading'; placeholder.innerHTML = `<span class="placeholder-status">Loading ${index + 1}/${total}...</span><code class="debug-url">Constructing URL...</code>`; imageContainer.appendChild(placeholder); const urlElement = placeholder.querySelector('.debug-url'); const statusElement = placeholder.querySelector('.placeholder-status'); const img = document.createElement('img'); img.id = 'loading-image-element'; const uniqueUrl = `${POLLINATIONS_BASE_URL}${encodedPrompt}?seed=${seed}&nologo=true`; console.log(`Requesting Image ${index + 1} URL:`, uniqueUrl); if(urlElement) urlElement.textContent = uniqueUrl; let timeoutId = null; const TIMEOUT_DURATION = 50000; const requestInfo = { imgElement: img, placeholder: placeholder, url: uniqueUrl, completed: false }; img.onload = () => { clearTimeout(timeoutId); if (generationCancelled) { reject({ type: 'cancelled', placeholder, url: uniqueUrl }); return; } img.removeAttribute('id'); requestInfo.completed = true; if (placeholder.parentNode === imageContainer) { imageContainer.replaceChild(img, placeholder); } currentBatchImageSources.push(uniqueUrl); resolve({ type: 'success' }); }; img.onerror = (error) => { clearTimeout(timeoutId); if (generationCancelled) { reject({ type: 'cancelled', placeholder, url: uniqueUrl }); return; } img.removeAttribute('id'); requestInfo.completed = true; placeholder.classList.remove('loading'); placeholder.classList.add('error'); if(statusElement) statusElement.innerHTML = `Image ${index + 1} Failed<br><small>Pollinations error.</small>`; console.error(`Error loading Pollinations image ${index + 1}: ${uniqueUrl}`, error); reject({ type: 'error', placeholder, url: uniqueUrl }); }; timeoutId = setTimeout(() => { if (generationCancelled || requestInfo.completed) return; img.src = ''; img.removeAttribute('id'); requestInfo.completed = true; placeholder.classList.remove('loading'); placeholder.classList.add('error'); if(statusElement) statusElement.innerHTML = `Image ${index + 1} Timed Out`; console.error(`Timeout loading Pollinations image ${index + 1}: ${uniqueUrl}`); reject({ type: 'timeout', placeholder, url: uniqueUrl }); }, TIMEOUT_DURATION); img.referrerPolicy = "no-referrer"; if (generationCancelled) { clearTimeout(timeoutId); reject({ type: 'cancelled', placeholder, url: uniqueUrl }); return; } img.src = uniqueUrl; }); }
        async function generateImages() { const mainPrompt = promptInput.value.trim(); const imageCount = parseInt(imageCountSelector.value, 10); if (!mainPrompt) { showStatus('Main prompt empty.', 'warning', 3000); return; } if (isNaN(imageCount) || imageCount < 1) { showStatus('Invalid image count.', 'error'); return; } clearStatus(); saveToPromptHistory(mainPrompt); imageContainer.innerHTML = ''; currentBatchImageSources = []; showStatus(`Requesting ${imageCount} image(s) sequentially...`, 'loading'); setOperationalButtonsDisabled(true); cancelBtn.style.display = 'inline-block'; generationCancelled = false; currentImageLoadPromise = null; let imagesLoaded = 0; let imagesErrored = 0; let imagesCancelled = 0; const encodedPrompt = encodeURIComponent(mainPrompt); const baseSeed = Math.floor(Math.random() * 1000000); for (let i = 0; i < imageCount; i++) { if (generationCancelled) { imagesCancelled = imageCount - i; console.log(`Generation cancelled before starting image ${i+1}`); for (let j = i; j < imageCount; j++) { const ph = document.createElement('div'); ph.className = 'image-placeholder cancelled'; ph.innerHTML = `Not Started (Cancelled)`; imageContainer.appendChild(ph); } break; } showStatus(`Loading image ${i + 1} of ${imageCount} (Seed: ${baseSeed + i})...`, 'loading'); try { currentImageLoadPromise = loadSingleImage(i, imageCount, encodedPrompt, mainPrompt, baseSeed + i); const result = await currentImageLoadPromise; currentImageLoadPromise = null; if (result.type === 'success') { imagesLoaded++; } } catch (errorInfo) { currentImageLoadPromise = null; if (errorInfo.type === 'cancelled') { imagesCancelled++; if (errorInfo.placeholder?.parentNode === imageContainer) { errorInfo.placeholder.classList.remove('loading'); errorInfo.placeholder.classList.add('cancelled'); errorInfo.placeholder.innerHTML = `Image ${i+1} Cancelled <code class="debug-url">${errorInfo.url || 'N/A'}</code>`; } if (!generationCancelled) cancelImageGeneration(); break; } else { imagesErrored++; } console.error(`Error processing image ${i+1}:`, errorInfo); } if (!generationCancelled && i < imageCount - 1) { await new Promise(res => setTimeout(res, INTER_REQUEST_DELAY_MS)); } } cancelBtn.style.display = 'none'; setOperationalButtonsDisabled(false); currentImageLoadPromise = null; if (imagesCancelled > 0) { showStatus(`Gen cancelled. Loaded: ${imagesLoaded}, Failed: ${imagesErrored}, Cancelled: ${imagesCancelled}.`, 'warning'); } else if (imagesErrored === imageCount) { showStatus(`Failed all ${imageCount}. Check URLs/Pollinations.`, 'error'); } else if (imagesErrored > 0) { showStatus(`Finished. Loaded: ${imagesLoaded}, Failed: ${imagesErrored}.`, 'warning', 5000); } else if (imagesLoaded === imageCount) { showStatus(`Generated ${imageCount} image(s)!`, 'success', 4000); } else { showStatus('Generation finished with unexpected state.', 'info'); } }


        // --- Lightbox Functions ---
        // (No changes needed in these functions for the tabs)
        function openLightbox(clickedSrc) { const imageIndex = currentBatchImageSources.indexOf(clickedSrc); if (imageIndex === -1 || currentBatchImageSources.length === 0) { console.error("Could not find clicked image source in current batch."); return; } currentLightboxIndex = imageIndex; updateLightboxView(); lightbox.style.display = 'block'; document.body.style.overflow = 'hidden'; } function closeLightbox() { lightbox.style.display = 'none'; document.body.style.overflow = ''; currentLightboxIndex = 0; } function updateLightboxView() { const totalImages = currentBatchImageSources.length; if (totalImages === 0 || currentLightboxIndex < 0 || currentLightboxIndex >= totalImages) { closeLightbox(); return; } lightboxImage.src = currentBatchImageSources[currentLightboxIndex]; lightboxPrevBtn.classList.toggle('disabled', currentLightboxIndex === 0); lightboxNextBtn.classList.toggle('disabled', currentLightboxIndex === totalImages - 1); } function showPrevImage() { if (currentLightboxIndex > 0) { currentLightboxIndex--; updateLightboxView(); } } function showNextImage() { if (currentLightboxIndex < currentBatchImageSources.length - 1) { currentLightboxIndex++; updateLightboxView(); } }

        // --- Tab Switching Logic ---
        function switchTab(event) {
            const clickedTabButton = event.target;
            const targetTabId = clickedTabButton.dataset.tab; // e.g., "tab-visuals"

            // Remove active class from all buttons and hide all content
            tabButtons.forEach(button => button.classList.remove('active'));
            tabContents.forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none'; // Explicitly hide
            });

            // Activate the clicked button
            clickedTabButton.classList.add('active');

            // Show the target content
            const targetContent = document.getElementById(targetTabId);
            if (targetContent) {
                targetContent.classList.add('active');
                targetContent.style.display = 'block'; // Explicitly show
            } else {
                console.error("Target tab content not found:", targetTabId);
            }
        }

        // --- Event Listeners ---
        generateBtn.addEventListener('click', generateImages); cancelBtn.addEventListener('click', cancelImageGeneration); enhanceAIBtn.addEventListener('click', enhancePromptAI); modifyBtn.addEventListener('click', modifyPromptAI); clearHistoryBtn.addEventListener('click', handleClearHistory); clearPromptBtn.addEventListener('click', () => { promptInput.value = ''; showStatus('Prompt cleared.', 'info', 1500); }); clearNegativeBtn.addEventListener('click', () => { negativePromptInput.value = ''; showStatus('Negative keywords cleared.', 'info', 1500); }); resetNegativeBtn.addEventListener('click', () => { negativePromptInput.value = STANDARD_NEGATIVE_KEYWORDS.join(', '); showStatus('Negative keywords reset to defaults.', 'info', 2000); });
        ollamaModelInput.addEventListener('change', (e) => {
             if(ollamaModelDisplay) ollamaModelDisplay.textContent = e.target.value || 'N/A';
         });
         // Apply button listeners are already set up above in "Style & Keywords"
         imageContainer.addEventListener('click', function(event) { if (event.target.tagName === 'IMG' && !event.target.closest('.image-placeholder')) { openLightbox(event.target.src); } }); lightboxCloseBtn.addEventListener('click', closeLightbox); lightboxPrevBtn.addEventListener('click', showPrevImage); lightboxNextBtn.addEventListener('click', showNextImage); lightbox.addEventListener('click', function(event) { if (event.target === lightbox) { closeLightbox(); } }); document.addEventListener('keydown', function(event) { if (lightbox.style.display === 'block') { if (event.key === 'Escape') { closeLightbox(); } else if (event.key === 'ArrowLeft') { showPrevImage(); } else if (event.key === 'ArrowRight') { showNextImage(); } } }); promptInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); generateImages(); } }); modificationInstructionInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); modifyPromptAI(); } });

         // Add Tab Button Listeners
         tabButtons.forEach(button => {
             button.addEventListener('click', switchTab);
         });


        // --- Initialisation ---
        window.addEventListener('load', () => { // Removed async
            loadPromptHistory();
            // No await fetchOllamaModels();
            if (negativePromptInput) { negativePromptInput.value = STANDARD_NEGATIVE_KEYWORDS.join(', '); } else { console.error("Negative prompt textarea not found!"); }
            if (ollamaModelInput && ollamaModelDisplay) { ollamaModelDisplay.textContent = ollamaModelInput.value; } // Set initial display
            if (loadHistoryBtn) { loadHistoryBtn.addEventListener('click', handleLoadFromHistory); console.log("Load History listener attached."); } else { console.error("Load History button not found!"); }

            // Ensure the default active tab content is displayed on load
            const activeTabContent = document.querySelector('.tab-content.active');
            if(activeTabContent) {
                activeTabContent.style.display = 'block';
            }

            showStatus('Ready.', 'info', 1500);
        });

    </script>
</body>
</html>
